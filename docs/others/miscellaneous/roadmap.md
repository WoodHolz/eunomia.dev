# bpftime roadmap and ideas for 2024

一些接下来 bpftime 可以做的方向整理：

## 1. 让 Userspace eBPF 和内核的 eBPF 协同工作，完成复杂任务，并且和 Kernel 的 eBPF 机制完全兼容

完善功能以无缝支持大型 eBPF 应用程序。当前的大型 eBPF 程序都需要内核态和用户态协同工作，把内核态和用户态的信息通过 maps 和读取相互关联起来，这也是和传统的 DBI 框架的不同之处。

我们将提供两种模式：

1. 仅在用户空间运行 eBPF（模式 1）
   - 可在非 Linux 系统上无需内核地运行
   - 对于大型 eBPF 应用并不非常适用，因为在共享内存中的映射无法被内核的 eBPF 程序所使用

2. 在用户空间与内核空间同时运行 eBPF，并配备 bpftime-daemon
   - 更好地与内核 eBPF 兼容，支持包含数千行 eBPF 代码的大型 eBPF 应用，同时支持 uprobe、kprobe、socket 等混合使用
   - 让内核态的 eBPF 与用户态的 eBPF 协同工作
   - 无需修改内核，但会改变 BPF 系统调用的行为
   - 这一思路与 fuse 有相似之处，需要一个内核中的 eBPF 程序和用户态的 bpftime-daemon 协同工作。

## 2. 探索 Userspace eBPF 和 Kernel eBPF 相结合的新的用户态和内核态交互的方式、编程模型

随着计算领域的不断进步，我们所面临的技术问题也变得越来越复杂。其中，如何减少内核与用户空间的交互开销，并提供更高效、更灵活的编程模型，成为了研究的热点。本文将深入探讨 eBPF（Extended Berkeley Packet Filter）如何为这一问题带来了新的解决方案。

### 现有的内核与用户空间交互策略

首先，我们需要认识到，上下文切换——尤其是在同步的系统调用中——确实会带来相当大的性能开销。为了优化这种交互，开发者和研究者们提出了以下几种策略：

- **iouring**：这是一个新的轻量级的异步I/O接口，旨在减少上下文切换，从而提高I/O操作的效率。iouring 通过 ring buffer 实现了用户空间和内核空间的双向数据传输，从而避免了传统的系统调用开销。
- **系统调用批处理**：这种策略会将多个系统调用合并为一个批次执行，从而减少上下文切换的次数。
- **异步系统调用**：与传统的同步系统调用不同，异步调用不需要等待其完成，从而可以继续执行其他任务。一般来说它的原理是：用户空间发起一个系统调用，内核立即返回，然后在后台执行这个系统调用，最后通知用户空间系统调用已经完成。

这些方法虽然取得了一定的成功，但在面对现代计算的复杂环境时，仍存在一些局限性。

### eBPF：新的交互方式

eBPF，一种在内核中运行的程序，提供了一种全新的机制来处理和优化用户空间和内核之间的交互。以下是 eBPF 所带来的几个关键特性：

- **eBPF maps**：eBPF maps 是一种特殊的数据结构，它们可以在用户空间和内核之间无缝地工作，极大地减少了数据交换的系统调用开销。
- **BPF_F_MMAP**：这个特性允许开发者将 eBPF maps 映射到用户空间和内核之间的共享内存，从而实现高效的数据访问。
- **eBPF Ring Buffer & eBPF User Ring Buffer**：与 iouring 类似，这两种 eBPF map 提供了一种高效的双向数据传输机制，进一步减少了系统调用的需要。
- **动态代码修改**：eBPF 的另一个显著特点是它可以在运行时修改和优化内核或用户空间的代码。这为开发者提供了一个强大的工具，使他们能够在不修改源代码或重新启动系统的情况下进行微调。
- **协同执行**：eBPF 允许部分功能在用户空间执行，部分在内核空间执行，两者可以协同工作，并异步调用。
- **By pass kernel**：eBPF 和用户空间协同工作，可以跳过一部分内核中传统的较长的处理路径，从而提高性能。例如，XDP 实现了一个高效的网络数据包处理路径，它可以在内核中跳过传统的网络协议栈，直接将数据包传递给用户空间的程序进行处理。

eBPF，作为一个相对较新的技术，已经展现出其强大的潜力，为内核与用户空间的交互带来了新的视角和工具。而它的真正价值可能还在继续发掘之中。不过，正如任何技术工具，它不是银弹，最终如何使用仍取决于具体的应用场景和需求。不过，毫无疑问，eBPF为我们提供了一个探索更高效、更灵活内核与用户态交互方式的宝贵机会。

## 3. bpftime + fuse: 探索用户态文件系统和内核态相结合并协同加速的可能性

在现代操作系统中，`fuse`（用户空间文件系统）已经成为了一个受欢迎的选择，允许开发者在用户空间创建文件系统，而无需对内核代码进行修改。但是，系统调用的成本仍然存在。这是`bpftime`能够发挥作用的地方。

**核心优势与可能性**:

1. **用户态和内核态协同优化**: 通过`bpftime`，可以在用户空间预先处理某些文件系统操作，如缓存、元数据查询等，并仅在真正需要的时候与内核空间的eBPF交互。这样，可以极大地减少不必要的系统调用，提高文件操作的速度，加速一些可能的快速路径，类似 XRP 的机制一样。
2. **用户态 bypass 的 Fuse 机制**: 我们可以做的完全 kernel bypass 的 fuse，使用 eBPF 将对应的用户态程序和 vfs 、libfuse 对接起来，实现完全的 kernel bypass 用户态文件系统，并且可以类似 fuse 那样，不需要对用户态应用进行侵入式改变或链接。
3. **动态调整策略**: 用户态的`bpftime`可以动态地收集性能数据，并据此调整策略，例如选择最佳的缓存策略，而这些都可以在运行时进行，无需停机或重启。
4. **更强的自定义能力**: 开发者可以根据具体的应用场景，定制特定的eBPF程序，以适应不同的工作负载和优化目标。

## 4. bpftime + network = cilium: 为网络通信带来协同智能

网络是现代计算环境中的基础，但随着越来越复杂的通信模式和高流量的需求，传统的网络处理方式可能无法满足现代应用的需求。在此背景下，`bpftime`与网络库的结合为我们提供了一种新的方法来处理网络请求。

**核心优势与可能性**:

1. **智能网络流处理**: `bpftime`允许开发者在用户空间预处理网络请求，例如：流量平衡、QoS策略等，并与内核空间的eBPF进行协同，只有在真正需要的时候进行系统调用。这样，可以有效减少上下文切换，提高网络效率。
2. **动态网络策略调整**: 与文件系统协同工作相似，`bpftime`可以动态地收集网络性能数据，并根据这些数据调整网络处理策略，例如：动态调整流量分配、快速切换通信路径等。
3. **更高的网络吞吐量**: 通过在用户空间预处理网络请求，可以避免传统网络堆栈的开销，从而实现更高的网络吞吐量，特别是在高流量和低延迟的场景中。可以将用户态 eBPF 和用户态的网络库结合起来，在类似 cilium 的场景中加速 service mesh 的网络请求转发和处理。

`bpftime`为用户空间和内核空间的协同工作开辟了新的可能性，无论是在文件系统还是网络通信方面。这种协同优化为我们提供了一个高效、灵活并且可自定义的框架，可以满足现代复杂计算环境的需求。未来，这种协同工作模式有可能成为操作系统和应用之间交互的标准方式。

## 5. 用户态 AOT 编译与运行 eBPF：轻量级容器的新机遇

**背景**：

在云原生、IoT 和嵌入式系统领域，资源受限、安全性要求高、部署与管理需要高度自动化是三大核心挑战。现有的容器技术，尽管提供了高度的抽象和隔离，但仍然带来了运行时的开销。用户态 eBPF 的潜在能力，特别是其Ahead-of-Time (AOT) 编译为机器码并签名的特性，为这些领域带来了新的可能性。

**目标**：

1. 开发一个用户态 eBPF 的 AOT 编译与运行机制，旨在为嵌入式和资源受限环境提供轻量级的、事件驱动的计算模型。
2. 将此技术融入 FaaS 轻量级容器，从而降低其启动延迟，并提高执行效率。
3. 设计和实施一个插件系统，允许 eBPF 程序嵌入到其他应用中，为其提供动态的、高度优化的功能扩展。

**挑战**：

1. **性能与安全平衡**：如何在保证eBPF程序的性能的同时，确保其在用户态的完全安全性，特别是在没有内核级别隔离的情况下。
2. **通用性与特定性**：设计一个系统，既要满足嵌入式和IoT设备的特定需求，又要具有足够的通用性，以适应不同的应用场景。
3. **兼容与创新**：如何确保新技术与现有的容器生态系统和IoT标准兼容，同时引入创新。

**可能性**：

1. **低开销的计算**：eBPF 的轻量级特性和AOT编译为机器码的能力，可以显著降低在受限资源环境下的计算开销。
2. **动态扩展性**：通过将 eBPF 程序作为插件嵌入到其他应用中，为各种应用提供高度动态的、按需加载的功能。
3. **跨平台和多场景应用**：eBPF 程序的可移植性和安全性使其成为多种平台和应用场景的理想选择，包括边缘计算、智能家居、车载系统等。

用户态 eBPF 的 AOT 编译与运行提供了一个独特的、具有高度潜力的方法，满足云原生、IoT 和嵌入式系统领域的挑战和需求。其独特的结合性能、安全性和灵活性的特点使其成为这些领域未来研究和创新的重要方向。

## 6. bpftime + Wasm: enhance Wasm with eBPF

结合WebAssembly (Wasm) 和用户态的 eBPF 是一个颇具前景的构想。WebAssembly 作为一个为现代网络应用设计的轻量级虚拟机，提供了跨平台和高效的执行环境。eBPF，则为我们提供了动态、高效和安全的系统级代码注入机制。将两者结合，不仅可以为 Wasm 带来更丰富的系统级功能，还可以为其提供更高的运行效率。

**核心思考与可能性**:

1. **动态追踪与可观测性**: 利用 eBPF 的动态追踪能力，Wasm 虚拟机中可以实现类似 kprobe 的功能，实时追踪 Wasm 代码的运行状态。这不仅可以用于性能分析和故障诊断，还可以为安全和审计提供有力的支持。
2. **网络与资源隔离**: eBPF 的 socket 过滤和流量控制功能可以为 Wasm 提供更精细和高效的网络隔离能力，确保 Wasm 应用之间的安全隔离。同时，eBPF 还可以用于动态配置 Wasi 的资源隔离模型，为每个 Wasm 应用提供精细的资源控制。之前也有其他人做了一些别的相关的尝试，比如 POSTER: Leveraging eBPF to enhance sandboxing of WebAssembly runtimes
3. **可移植性与独立性**: 由于Wasm的设计目标是跨平台和可移植性，结合用户态的eBPF可以确保这一目标不受影响。eBPF代码可以在任何支持Wasm和eBPF的平台上运行，无需依赖特定的内核版本或操作系统。
4. **生态与开发难度**: 你提到的eBPF的多语言生态问题和开发难度，确实是一个挑战。但随着eBPF生态的日益丰富和成熟，这一问题有望得到缓解。而Wasm则为开发者提供了一个熟悉和友好的编程模型，可以用于开发具体的业务逻辑。
5. **扩展性**: 结合eBPF和Wasm，还可以考虑实现更多的功能，例如实时代码更新、热补丁、动态资源分配等。

**挑战与拓展**:

1. **安全性**: eBPF和Wasm都有各自的安全模型，结合使用时需要确保两者的安全性能够相互增强，而不是相互削弱。
2. **性能**: 尽管eBPF和Wasm都是为高效而设计的，但在实际使用中可能会面临一些性能挑战，如代码注入、动态追踪等。需要进行深入的性能分析和优化。
3. **工具和生态**: 结合eBPF和Wasm可能需要开发新的工具和框架，支持开发、部署和管理这种新型应用。这时候我们做的 `Wasm-bpf` 就可以发挥作用了。

结合用户态的 eBPF 和 WebAssembly 是一个具有潜力的方向，可以为现代应用提供更丰富、更高效和更安全的功能。但这同时也带来了一系列的技术挑战，需要进行深入的研究和探索。

## 7. bpftime + LLM 自动生成 eBPF 代码，为用户空间性能分析、数据整合和动态插桩提供全新机制

**背景**：

随着复杂系统的演进，不仅仅是编写有效的 eBPF 代码变得具有挑战性，还有在用户态和内核态之间对数据进行深入关联和整理的需求。当前，市场上缺乏能够结合语义信息（如变量名、代码注释等）与实际采集到的数据进行自动化分析的解决方案。bpftime 作为一个在用户态执行 eBPF 的工具，与大型语言模型（如 GPT-4）相结合，可能为这一领域带来革命性的变革。

**目标**：

1. 利用 bpftime 和 GPT-4 创建一个框架，能够自动生成高效的 eBPF 代码，并理解性能分析的复杂需求。
2. 设计机制，将内核态和用户态的数据进行关联与整合，并结合语义信息为开发者提供有深度的洞见。
3. 利用用户态的灵活性，为 bpftime 开发自动数据流生成、错误注入、实时补丁等功能，以强化其动态追踪能力。

**挑战**：

1. **语义整合**：自动识别和整合代码中的语义信息与实际数据是一项巨大的挑战。这需要深度理解代码、注释、变量名等，以及它们如何与实际数据关联。
2. **数据流生成与错误注入**：在用户态自动生成数据流以进行测试，同时进行错误注入，需要一个精确且可靠的机制，以确保测试结果的准确性并不会对生产环境造成危害。
3. **实时补丁技术**：实时地在用户态对代码进行补丁是一项技术挑战，需要确保补丁不会引入新的错误或性能问题。

**可能性**：

1. **深度分析**：结合内核态和用户态数据，以及与代码的语义信息关联，能为开发者提供更深入的性能和行为分析。
2. **自动化测试与错误注入**：利用 bpftime 的灵活性，可以在用户态自动化地生成各种数据流、注入错误，提供全面的测试覆盖。
3. **动态修补与实时反应**：为代码在运行时应用补丁，不仅可以快速响应问题，还可以优化性能，满足系统的动态需求。

结合 bpftime 和大型语言模型，自动化地生成 eBPF 代码、关联内核态与用户态数据、并实施动态插桩，为性能分析和系统优化提供了一个具有潜力的研究方向。尽管存在一些技术和实施挑战，但考虑到潜在的长期收益，这一研究课题无疑是值得进一步探索的。
